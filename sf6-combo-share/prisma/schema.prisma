generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// ENUM
//
enum ComboPlayStyle {
  MODERN
  CLASSIC
}

enum ConditionType {
  NORMAL
  COUNTER
  PUNISH
  FORCEDOWN
}

enum AttributeType {
  NONE
  OD
  CR
  PR
}

//
// USERS
//
model User {
  id          Int       @id @default(autoincrement())
  name        String
  email       String    @unique
  password    String
  profile     String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  combos      Combo[]
  comments    Comment[]
  favorites   Favorite[]
  ratings     Rating[]

  @@map("users")
}

//
// CHARACTERS
//
model Character {
  id          Int       @id @default(autoincrement())
  name        String
  image       String?
  description String?   @db.Text

  moves       Move[]
  combos      Combo[]

  @@map("characters")
}

//
// MOVES（必殺技のみ）
//
model Move {
  id          Int       @id @default(autoincrement())
  characterId Int       @map("character_id")
  name        String
  input       String?

  character   Character @relation(fields: [characterId], references: [id])
  steps       ComboStep[]

  @@map("moves")
}

//
// ATTRIBUTES
//
model Attribute {
  id          Int            @id @default(autoincrement())
  type        AttributeType  @map("type")
  description String?        @db.Text

  combos      Combo[]
  steps       ComboStep[]

  @@map("attributes")
}

//
// CONDITIONS
//
model Condition {
  id          Int            @id @default(autoincrement())
  type        ConditionType  @map("type")
  description String?        @db.Text

  combos      Combo[]

  @@map("conditions")
}

//
// COMBOS（starterMoveId 削除済）
//
model Combo {
  id            Int             @id @default(autoincrement())
  parentComboId Int?            @map("parent_combo_id")
  userId        Int             @map("user_id")
  characterId   Int             @map("character_id")
  conditionId   Int             @map("condition_id")
  attributeId   Int?            @map("attribute_id")
  playStyle     ComboPlayStyle  @map("play_style")
  comboText     String          @map("combo_text") @db.Text
  damage        Int?
  frame         Int?
  version       String?         @default("1.00")
  description   String?         @db.Text
  videoUrl      String?         @map("video_url")
  createdAt     DateTime        @default(now()) @map("created_at")

  user          User            @relation(fields: [userId], references: [id])
  character     Character       @relation(fields: [characterId], references: [id])
  condition     Condition       @relation(fields: [conditionId], references: [id])
  attribute     Attribute?      @relation(fields: [attributeId], references: [id])

  parentCombo   Combo?          @relation("ComboParent", fields: [parentComboId], references: [id])
  childCombos   Combo[]         @relation("ComboParent")

  steps         ComboStep[]
  tags          ComboTag[]
  comments      Comment[]
  favorites     Favorite[]
  ratings       Rating[]

  @@map("combos")
}

//
// COMBO STEPS
//
model ComboStep {
  id          Int        @id @default(autoincrement())
  comboId     Int        @map("combo_id")
  order       Int        @map("order_index")
  moveId      Int?       @map("move_id")
  attributeId Int?       @map("attribute_id")
  note        String?

  combo       Combo      @relation(fields: [comboId], references: [id])
  move        Move?      @relation(fields: [moveId], references: [id])
  attribute   Attribute? @relation(fields: [attributeId], references: [id])

  @@unique([comboId, order])
  @@map("combo_steps")
}

//
// TAGS
//
model Tag {
  id          Int        @id @default(autoincrement())
  name        String
  description String?    @db.Text

  combos      ComboTag[]

  @@map("tags")
}

//
// COMBO_TAGS
//
model ComboTag {
  comboId Int @map("combo_id")
  tagId   Int @map("tag_id")

  combo   Combo @relation(fields: [comboId], references: [id])
  tag     Tag   @relation(fields: [tagId], references: [id])

  @@id([comboId, tagId])
  @@map("combo_tags")
}

//
// COMMENTS
//
model Comment {
  id        Int      @id @default(autoincrement())
  comboId   Int      @map("combo_id")
  userId    Int      @map("user_id")
  comment   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  combo     Combo    @relation(fields: [comboId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

//
// FAVORITES
//
model Favorite {
  id        Int      @id @default(autoincrement())
  comboId   Int      @map("combo_id")
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  combo     Combo    @relation(fields: [comboId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([comboId, userId])
  @@map("favorites")
}

//
// RATINGS
//
model Rating {
  id        Int      @id @default(autoincrement())
  comboId   Int      @map("combo_id")
  userId    Int      @map("user_id")
  value     Int
  createdAt DateTime @default(now()) @map("created_at")

  combo     Combo    @relation(fields: [comboId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([comboId, userId])
  @@map("ratings")
}
